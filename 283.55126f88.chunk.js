"use strict";(self.webpackChunk_app_client=self.webpackChunk_app_client||[]).push([[283],{283:function(e,t,n){n.r(t),n.d(t,{default:function(){return F}});var r=n(294),a=n(977),i=n(12),c=n(477),o=n(762),l=n(433),s={position:new c.Vector3(0,0,20)};let u,h;!function(e){e[e.up=0]="up",e[e.down=1]="down",e[e.left=2]="left",e[e.right=3]="right"}(u||(u={})),function(e){e[e.none=0]="none",e[e.up=1]="up",e[e.down=2]="down",e[e.left=3]="left",e[e.right=4]="right"}(h||(h={}));var m={direction:h.none,position:new c.Vector3(0,0,0),velocity:new c.Vector3(0,0,0),speed:.1},p=15,f=15,d={width:16,height:16},w={width:1,height:22/15};function g(e){let{children:t}=e;const[n,a]=r.useMemo((()=>[new c.Vector3(-.5*p+.5*w.width,-.5*f+.5*w.height,0),new c.Vector3(.5*p-.5*w.width,.5*f-.5*w.height,0)]),[]);return(0,o.x)((e=>{let{camera:t}=e;m.position.add(m.velocity.multiplyScalar(m.speed)).clamp(n,a),t.position.copy(m.position),t.position.z=s.position.z,t.rotation.set(0,0,0)})),r.createElement(r.Fragment,null,r.createElement(l.c,{makeDefault:!0,position:s.position},r.createElement("group",{"position-z":-1*s.position.z},t)))}function E(e){const t=e.replace(/^\/+/,"");return"".concat("./").concat(t)}function b(){const e=r.useRef(null),{canvas:t,ctx:n,texture:a}=r.useMemo((()=>{const e=document.createElement("canvas"),t=e.getContext("2d"),n=new c.Texture(e);return n.minFilter=c.NearestFilter,n.magFilter=c.NearestFilter,{canvas:e,ctx:t,texture:n}}),[]);return r.useEffect((()=>{const r=[];for(let e=0;e<f;e++){r.push([]);for(let t=0;t<p;t++)r[e].push(c.MathUtils.randInt(1,8))}let i;return(async()=>{const o={};for(let e=1;e<=8;e++)await new Promise((t=>{o[e]=new Image,o[e].onload=t,o[e].src=E("/assets/map/".concat(e,".png"))}));t.width=p*d.width,t.height=f*d.height;for(let e=0;e<f;e++)for(let t=0;t<p;t++){const a=o[r[e][t]];n.drawImage(a,t*d.width,e*d.height,d.width,d.height)}const l=new Image;function s(){if(i=requestAnimationFrame(s),null===e.current)return;n.clearRect(0,0,t.width,t.height),n.globalCompositeOperation="destination-atop",n.globalAlpha=.25;const r=c.MathUtils.mapLinear(m.position.x,-.5*p,.5*p,0,t.width),o=c.MathUtils.mapLinear(m.position.y,.5*f,-.5*f,0,t.height),u=Math.floor(r/d.width),h=Math.floor(o/d.height);n.fillStyle="#ffd700",n.fillRect(u*d.width,h*d.height,d.width,d.height),n.globalAlpha=1,n.drawImage(l,0,0,t.width,t.height),a.needsUpdate=!0}t.toBlob((async t=>{null!==e.current&&URL.revokeObjectURL(e.current),e.current=URL.createObjectURL(t),l.onload=()=>s(),l.src=e.current}))})(),()=>{null!==e.current&&URL.revokeObjectURL(e.current),cancelAnimationFrame(i)}}),[a,t,n]),r.createElement("group",null,r.createElement("mesh",null,r.createElement("planeBufferGeometry",{args:[p,f]}),r.createElement("meshBasicMaterial",{depthWrite:!1,map:a})))}function k(e,t,n){const a=r.useRef(t);r.useMemo((()=>{a.current=t}),[t]);const i=r.useRef(n);r.useMemo((()=>{i.current=n}),[n]),r.useEffect((()=>(window.addEventListener(e,a.current,i.current),()=>{window.removeEventListener(e,a.current,i.current)})),[e])}function y(e){let{color:t="#ffd700"}=e;const n=function(){const[e,t]=r.useState([]);function n(e){let t;switch(e.toLocaleLowerCase()){case"w":case"arrowup":t=u.up;break;case"s":case"arrowdown":t=u.down;break;case"a":case"arrowleft":t=u.left;break;case"d":case"arrowright":t=u.right}return t}return k("keydown",(e=>{const r=n(e.key);void 0!==r&&t((e=>e.includes(r)?e:[...e,r]))})),k("keyup",(e=>{const r=n(e.key);void 0!==r&&t((e=>e.filter((e=>e!==r))))})),e}(),{canvas:a,ctx:i,texture:l}=r.useMemo((()=>{const e=document.createElement("canvas"),t=e.getContext("2d"),n=new c.Texture(e);return n.minFilter=c.NearestFilter,n.magFilter=c.NearestFilter,{canvas:e,ctx:t,texture:n}}),[]);return r.useEffect((()=>{const e=new Image;e.onload=()=>p(),e.src=E("/assets/player/knight.png");const n={idle:{fps:8,frames:4,startX:0,startY:22,width:15,height:22},run:{fps:24,frames:4,startX:0,startY:0,width:15,height:22}};let r,c=0,o="idle",s=1,u=0;function p(){r=requestAnimationFrame(p);const f=1e3/n[o].fps,d=n[o].width,w=n[o].height,g=n[o].frames,E=n[o].startX,b=n[o].startY;a.width=d,a.height=w;const k=Date.now();if(!(k-c<f)){switch(c=k,m.direction){case h.none:o="idle";break;case h.right:s=1,o="run";break;case h.left:s=-1,o="run";break;case h.down:case h.up:o="run"}i.clearRect(0,0,a.width,a.height),i.globalCompositeOperation="destination-atop",i.globalAlpha=.25,i.fillStyle=t,i.fillRect(0,0,d,w),i.globalAlpha=1,i.save(),i.scale(s,1),i.drawImage(e,E+d*u,b+0*w,d,w,0,0,d*s,1*w),++u>g-1&&(u=E),i.restore(),l.needsUpdate=!0}}return()=>cancelAnimationFrame(r)}),[a,i,l,t]),(0,o.x)((()=>{let e=0;for(let t=0,r=n.length;t<r;t++)switch(n[t]){case u.up:e=h.up;break;case u.down:e=h.down;break;case u.left:e=h.left;break;case u.right:e=h.right}switch(e){case h.none:m.velocity.set(0,0,0);break;case h.up:m.velocity.y=1;break;case h.down:m.velocity.y=-1;break;case h.left:m.velocity.x=-1;break;case h.right:m.velocity.x=1;break;default:m.velocity.set(0,0,0)}m.direction=e})),r.createElement("group",null,r.createElement("mesh",null,r.createElement("planeBufferGeometry",{args:[w.width,w.height]}),r.createElement("meshBasicMaterial",{depthWrite:!1,transparent:!0,map:l})))}var v=3,x=3;function M(){const e=r.createRef(),t=r.createRef(),{size:n,camera:a}=(0,o.w)();return r.useEffect((()=>{const t=e.current,n=a,r=c.MathUtils.degToRad(n.fov),i=2*Math.tan(r/2)*s.position.z,o=i*n.aspect;t.position.set(-.5*o+.5*v+.5,-.5*i+.5*x+.5,t.position.z)}),[n,a]),(0,o.x)((()=>{t.current.position.copy(m.position).multiplyScalar(v/p)})),r.createElement("group",{ref:e},r.createElement("mesh",null,r.createElement("planeBufferGeometry",{args:[v,x]}),r.createElement("meshBasicMaterial",{color:"black",depthWrite:!1})),r.createElement("mesh",{ref:t},r.createElement("planeBufferGeometry",{args:[w.width*(v/p),w.height*(x/f)]}),r.createElement("meshBasicMaterial",{color:"crimson",depthWrite:!1})))}function R(){return r.createElement(a.Xz,{flat:!0,linear:!0,dpr:1},r.createElement(r.Suspense,{fallback:r.createElement(i.x,null,"Loading...")},r.createElement(b,null),r.createElement(g,null,r.createElement(y,null),r.createElement(M,null))))}function F(){return r.createElement(r.Fragment,null,r.createElement(R,null))}}}]);
//# sourceMappingURL=283.55126f88.chunk.js.map